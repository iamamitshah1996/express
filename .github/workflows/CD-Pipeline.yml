name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: SSH into EC2 and deploy Docker container
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ” Logging in to Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            echo "ğŸ“¦ Pulling latest Docker image..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/hello-world:latest

            echo "ğŸ§¹ Cleaning up old container (if exists)..."
            docker stop staging-app || true
            docker rm staging-app || true

            echo "ğŸ’¾ Tagging rollback image..."
            docker tag ${{ secrets.DOCKER_USERNAME }}/hello-world:latest hello-world:rollback || true

            echo "ğŸš€ Running new container..."
            docker run -d --name staging-app -p 8080:8080 ${{ secrets.DOCKER_USERNAME }}/hello-world:latest

            echo "ğŸ©º Performing health check..."
            sleep 5
            if curl -fs http://localhost:8080; then
              echo "âœ… Deployment successful!"
            else
              echo "âŒ Health check failed. Rolling back..."
              docker stop staging-app || true
              docker rm staging-app || true
              docker run -d --name staging-app -p 8080:8080 hello-world:rollback
            fi
